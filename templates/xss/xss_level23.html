{% extends 'base.html' %}

{% block title %}Level 23: XSS in Federated Identity Systems - R00tGlyph{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h2 class="text-center">Level 23: XSS in Federated Identity Systems</h2>
            </div>
            <div class="card-body">
                <div class="alert alert-dark challenge-description">
                    <h4><i class="bi bi-info-circle-fill me-2"></i>Challenge Description</h4>
                    <p>
                        Welcome to <strong>IdentityHub</strong>, a fictional federated identity provider! This challenge simulates a real-world scenario where a federated identity system has an XSS vulnerability in its authentication flow.
                    </p>
                    
                    <div class="card mb-3 border-secondary">
                        <div class="card-header">
                            <i class="bi bi-briefcase-fill me-2"></i>Mission Briefing
                        </div>
                        <div class="card-body">
                            <p class="mb-0">
                                <strong>Client:</strong> IdentityHub Inc.<br>
                                <strong>Target:</strong> Federated Identity Provider<br>
                                <strong>Vulnerability:</strong> XSS in Authentication Flow<br>
                                <strong>Objective:</strong> Exploit the federated identity system to execute arbitrary JavaScript
                            </p>
                        </div>
                    </div>
                    
                    <p>
                        <strong>Technical Background:</strong> Federated identity systems allow users to use a single identity to access multiple applications and services. These systems typically use protocols like OAuth 2.0, OpenID Connect, and SAML to authenticate users and share identity information between identity providers and service providers. The authentication flow often involves redirects, token exchanges, and user consent screens. If these flows are not properly secured, they can introduce XSS vulnerabilities.
                    </p>
                    
                    <p>
                        <strong>Real-world Impact:</strong> Federated identity vulnerabilities are particularly dangerous because:
                    </p>
                    <ul>
                        <li>They can compromise authentication across multiple applications and services</li>
                        <li>They often handle sensitive personal information and credentials</li>
                        <li>They typically have high levels of trust from users and applications</li>
                        <li>They can lead to account takeovers and identity theft</li>
                        <li>They can be difficult to detect due to the complex nature of federated authentication flows</li>
                    </ul>
                    
                    <p>
                        <strong>Your Task:</strong> In this challenge, you need to exploit a vulnerability in the IdentityHub application. The application allows users to authenticate using a federated identity provider and access various services. However, there's a vulnerability in how the application handles and displays authentication parameters. Find a way to inject JavaScript that will be executed during the authentication flow. Make an alert box appear with the text "XSS Level 23 Completed!" to reveal the flag.
                    </p>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-lightbulb-fill me-2"></i><strong>Hint:</strong> Look for ways to inject code into authentication parameters that will be processed and displayed without proper sanitization. The vulnerability might be in how the application handles redirect URLs or error messages.
                    </div>
                </div>
                
                <!-- IdentityHub Interface -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>IdentityHub</h5>
                        <div>
                            <span class="badge bg-light text-dark">Federated Identity Provider</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Navigation Bar -->
                        <nav class="navbar navbar-expand navbar-light bg-light px-3">
                            <div class="container-fluid">
                                <ul class="navbar-nav">
                                    <li class="nav-item"><a class="nav-link active" href="#"><i class="bi bi-house-door me-1"></i>Home</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-shield-lock me-1"></i>Identity</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-app me-1"></i>Applications</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-gear me-1"></i>Settings</a></li>
                                </ul>
                                <div class="d-flex">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="bi bi-person-circle me-1"></i>Guest User
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                            <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
                                            <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </nav>
                        
                        <div class="p-4">
                            <div class="row">
                                <div class="col-md-4 mb-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Identity Provider</h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="small mb-2"><strong>Provider:</strong> IdentityHub</p>
                                            <p class="small mb-2"><strong>Protocol:</strong> OpenID Connect</p>
                                            <p class="small mb-0"><strong>Status:</strong> <span class="text-success">Active</span></p>
                                            <hr>
                                            <p class="small mb-0 fst-italic">This is a simulated federated identity environment for the challenge.</p>
                                        </div>
                                    </div>
                                    
                                    <div class="card mt-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">Connected Applications</h6>
                                        </div>
                                        <div class="list-group list-group-flush">
                                            <a href="#" class="list-group-item list-group-item-action" onclick="selectApplication('app1')">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <i class="bi bi-cloud me-2"></i>Cloud Storage
                                                    </div>
                                                    <span class="badge bg-success rounded-pill">Connected</span>
                                                </div>
                                            </a>
                                            <a href="#" class="list-group-item list-group-item-action" onclick="selectApplication('app2')">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <i class="bi bi-envelope me-2"></i>Email Service
                                                    </div>
                                                    <span class="badge bg-success rounded-pill">Connected</span>
                                                </div>
                                            </a>
                                            <a href="#" class="list-group-item list-group-item-action" onclick="selectApplication('app3')">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <i class="bi bi-calendar me-2"></i>Calendar App
                                                    </div>
                                                    <span class="badge bg-secondary rounded-pill">Disconnected</span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                    
                                    <div class="card mt-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">Authentication Simulator</h6>
                                        </div>
                                        <div class="card-body">
                                            <p class="small mb-2">Simulate an authentication request with custom parameters:</p>
                                            <div class="mb-3">
                                                <label for="client-id" class="form-label">Client ID</label>
                                                <input type="text" class="form-control form-control-sm" id="client-id" value="client_12345">
                                            </div>
                                            <div class="mb-3">
                                                <label for="redirect-uri" class="form-label">Redirect URI</label>
                                                <input type="text" class="form-control form-control-sm" id="redirect-uri" value="https://example.com/callback">
                                            </div>
                                            <div class="mb-3">
                                                <label for="state" class="form-label">State</label>
                                                <input type="text" class="form-control form-control-sm" id="state" value="random_state_123">
                                            </div>
                                            <div class="mb-3">
                                                <label for="response-type" class="form-label">Response Type</label>
                                                <select class="form-select form-select-sm" id="response-type">
                                                    <option value="code">code</option>
                                                    <option value="token">token</option>
                                                    <option value="id_token">id_token</option>
                                                </select>
                                            </div>
                                            <div class="d-grid">
                                                <button class="btn btn-sm btn-primary" id="simulate-auth-btn">
                                                    <i class="bi bi-shield-lock me-2"></i>Simulate Authentication
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-8">
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h5 class="mb-0" id="auth-flow-title">Authentication Flow</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="auth-flow-content">
                                                <!-- Authentication flow will be displayed here -->
                                                <div class="text-center py-5">
                                                    <i class="bi bi-shield-lock display-1 text-muted"></i>
                                                    <p class="mt-3">No authentication flow in progress. Click "Simulate Authentication" to start a flow.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">Authentication Log</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="auth-log" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                                                <!-- Authentication log will be displayed here -->
                                                <p class="text-muted mb-0">Authentication log will appear here during the authentication flow.</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {% if flag %}
                                    <div class="alert alert-success mt-4">
                                        <i class="bi bi-check-circle-fill me-2"></i>
                                        <strong>Congratulations!</strong> Your XSS payload successfully executed in the federated identity system.
                                    </div>
                                    <div class="card mt-2">
                                        <div class="card-header">
                                            <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>Challenge Completed!</h5>
                                        </div>
                                        <div class="card-body">
                                            <p>You've successfully demonstrated an XSS vulnerability in a federated identity system. In a real-world scenario, this could allow attackers to execute arbitrary JavaScript during the authentication flow, potentially leading to account takeovers, identity theft, and other attacks.</p>
                                            <div class="flag-container p-3 bg-light rounded">
                                                <span class="flag-label">Your Flag:</span>
                                                <code id="flag-value">{{ flag }}</code>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <a href="{{ url_for('solutions', level=23) }}" class="btn btn-outline-secondary"><i class="bi bi-lightbulb-fill me-2"></i>View Solution</a>
                    <a href="{{ url_for('vulnerabilities') }}" class="btn btn-outline-primary float-end"><i class="bi bi-arrow-left me-2"></i>Back to Challenges</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Simulated federated identity system
    class FederatedIdentitySystem {
        constructor() {
            this.isAuthenticated = false;
            this.currentApplication = null;
            this.authFlowSteps = [];
            this.authLog = [];
            
            // Applications
            this.applications = {
                app1: {
                    id: 'app1',
                    name: 'Cloud Storage',
                    clientId: 'client_12345',
                    redirectUri: 'https://cloudstorage.example.com/callback',
                    scopes: ['profile', 'email', 'storage'],
                    icon: 'bi-cloud'
                },
                app2: {
                    id: 'app2',
                    name: 'Email Service',
                    clientId: 'client_67890',
                    redirectUri: 'https://email.example.com/callback',
                    scopes: ['profile', 'email'],
                    icon: 'bi-envelope'
                },
                app3: {
                    id: 'app3',
                    name: 'Calendar App',
                    clientId: 'client_abcde',
                    redirectUri: 'https://calendar.example.com/callback',
                    scopes: ['profile', 'calendar'],
                    icon: 'bi-calendar'
                }
            };
        }
        
        // Select an application
        selectApplication(appId) {
            this.currentApplication = this.applications[appId];
            
            // Update the authentication simulator form
            document.getElementById('client-id').value = this.currentApplication.clientId;
            document.getElementById('redirect-uri').value = this.currentApplication.redirectUri;
            
            // Log the selection
            this.addToLog(`Selected application: ${this.currentApplication.name}`);
        }
        
        // Simulate authentication
        simulateAuthentication(clientId, redirectUri, state, responseType) {
            // Reset the auth flow
            this.authFlowSteps = [];
            this.isAuthenticated = false;
            
            // Validate the client ID
            const app = Object.values(this.applications).find(a => a.clientId === clientId);
            if (!app) {
                this.addToLog('Error: Invalid client ID', true);
                this.updateAuthFlow('error', 'Invalid client ID', { clientId });
                return;
            }
            
            // Validate the redirect URI
            if (!redirectUri) {
                this.addToLog('Error: Missing redirect URI', true);
                this.updateAuthFlow('error', 'Missing redirect URI', { redirectUri });
                return;
            }
            
            // Start the authentication flow
            this.addToLog(`Starting authentication flow for ${app.name}`);
            this.updateAuthFlow('start', 'Authentication Request', { clientId, redirectUri, state, responseType });
            
            // Simulate user login
            setTimeout(() => {
                this.addToLog('User login step');
                this.updateAuthFlow('login', 'User Login', { username: 'user@example.com' });
                
                // Simulate consent screen
                setTimeout(() => {
                    this.addToLog('Consent screen step');
                    this.updateAuthFlow('consent', 'User Consent', { scopes: app.scopes });
                    
                    // Simulate token generation
                    setTimeout(() => {
                        this.addToLog('Token generation step');
                        
                        // Generate a token based on the response type
                        let token;
                        switch (responseType) {
                            case 'code':
                                token = `authorization_code_${Math.random().toString(36).substring(2, 15)}`;
                                break;
                            case 'token':
                                token = `access_token_${Math.random().toString(36).substring(2, 15)}`;
                                break;
                            case 'id_token':
                                token = `id_token_${Math.random().toString(36).substring(2, 15)}`;
                                break;
                            default:
                                token = `unknown_token_${Math.random().toString(36).substring(2, 15)}`;
                        }
                        
                        this.updateAuthFlow('token', 'Token Generation', { token, responseType });
                        
                        // Simulate redirect
                        setTimeout(() => {
                            this.addToLog(`Redirecting to: ${redirectUri}`);
                            
                            // This is the vulnerable part - it directly renders the redirect URI and state
                            // without sanitizing them, allowing XSS
                            this.updateAuthFlow('redirect', 'Redirect to Client', { redirectUri, state, token, responseType });
                            
                            // Simulate completion
                            setTimeout(() => {
                                this.addToLog('Authentication flow completed');
                                this.isAuthenticated = true;
                                this.updateAuthFlow('complete', 'Authentication Complete', { success: true });
                            }, 1000);
                        }, 1000);
                    }, 1000);
                }, 1000);
            }, 1000);
        }
        
        // Update the authentication flow display
        updateAuthFlow(step, title, data) {
            const authFlowContent = document.getElementById('auth-flow-content');
            
            // Add the step to the flow
            this.authFlowSteps.push({ step, title, data });
            
            // Render the current step
            switch (step) {
                case 'start':
                    authFlowContent.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Authentication Request</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Client ID:</strong> ${data.clientId}</p>
                                <p><strong>Redirect URI:</strong> ${data.redirectUri}</p>
                                <p><strong>State:</strong> ${data.state}</p>
                                <p><strong>Response Type:</strong> ${data.responseType}</p>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 20%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                
                case 'login':
                    authFlowContent.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">User Login</h5>
                            </div>
                            <div class="card-body">
                                <div class="text-center mb-4">
                                    <i class="bi bi-person-circle display-1"></i>
                                    <h4 class="mt-3">Welcome back, ${data.username}</h4>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 40%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                
                case 'consent':
                    authFlowContent.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">User Consent</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-4">
                                    <h5>The application is requesting access to:</h5>
                                    <ul>
                                        ${data.scopes.map(scope => `<li>${scope}</li>`).join('')}
                                    </ul>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 60%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                
                case 'token':
                    authFlowContent.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Token Generation</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Response Type:</strong> ${data.responseType}</p>
                                <p><strong>Token:</strong> <code>${data.token}</code></p>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 80%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                
                case 'redirect':
                    // This is the vulnerable part - it directly renders the redirect URI and state
                    // without sanitizing them, allowing XSS
                    authFlowContent.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Redirect to Client</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Redirect URI:</strong> <span id="redirect-uri-display">${data.redirectUri}</span></p>
                                <p><strong>State:</strong> <span id="state-display">${data.state}</span></p>
                                <p><strong>Token:</strong> <code>${data.token}</code></p>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 90%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                
                case 'complete':
                    authFlowContent.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Authentication Complete</h5>
                            </div>
                            <div class="card-body">
                                <div class="text-center">
                                    <i class="bi bi-check-circle-fill display-1 text-success"></i>
                                    <h4 class="mt-3">Authentication Successful</h4>
                                    <p>The user has been successfully authenticated.</p>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                
                case 'error':
                    authFlowContent.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Authentication Error</h5>
                            </div>
                            <div class="card-body">
                                <div class="text-center">
                                    <i class="bi bi-exclamation-triangle-fill display-1 text-danger"></i>
                                    <h4 class="mt-3">Authentication Failed</h4>
                                    <p>${title}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
        }
        
        // Add a message to the authentication log
        addToLog(message, isError = false) {
            const authLog = document.getElementById('auth-log');
            const timestamp = new Date().toLocaleTimeString();
            
            // Add the message to the log
            this.authLog.push({ timestamp, message, isError });
            
            // Render the log
            if (this.authLog.length === 1) {
                authLog.innerHTML = '';
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = isError ? 'text-danger mb-2' : 'mb-2';
            logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
            
            authLog.appendChild(logEntry);
            
            // Scroll to the bottom of the log
            authLog.scrollTop = authLog.scrollHeight;
        }
    }
    
    // Initialize the federated identity system
    const identitySystem = new FederatedIdentitySystem();
    
    // DOM elements
    const clientIdInput = document.getElementById('client-id');
    const redirectUriInput = document.getElementById('redirect-uri');
    const stateInput = document.getElementById('state');
    const responseTypeSelect = document.getElementById('response-type');
    const simulateAuthBtn = document.getElementById('simulate-auth-btn');
    
    // Event listeners
    simulateAuthBtn.addEventListener('click', () => {
        const clientId = clientIdInput.value.trim();
        const redirectUri = redirectUriInput.value.trim();
        const state = stateInput.value.trim();
        const responseType = responseTypeSelect.value;
        
        identitySystem.simulateAuthentication(clientId, redirectUri, state, responseType);
    });
    
    // Select application
    function selectApplication(appId) {
        identitySystem.selectApplication(appId);
    }
    
    // Check for XSS success
    window.addEventListener('DOMContentLoaded', function() {
        // Original alert function
        var originalAlert = window.alert;
        
        // Override alert
        window.alert = function(message) {
            // Call the original alert
            originalAlert(message);
            
            // Check if this is the success message
            if (message === "XSS Level 23 Completed!") {
                // Redirect to success page
                window.location.href = window.location.href + "?success=true";
            }
        };
    });
</script>
{% endblock %}
