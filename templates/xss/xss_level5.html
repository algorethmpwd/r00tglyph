{% extends 'base.html' %}

{% block title %}Level 5: XSS with Advanced Filters - R00tGlyph{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h2 class="text-center">Level 5: XSS with Advanced Filters</h2>
            </div>
            <div class="card-body">
                <div class="alert alert-dark challenge-description">
                    <h4><i class="bi bi-info-circle-fill me-2"></i>Challenge Description</h4>
                    <p>
                        Welcome to <strong>SecureBlog Enterprise</strong>, a high-security content management system used by Fortune 500 companies. Your red team has been contracted to assess their latest security upgrade.
                    </p>

                    <div class="card mb-3 border-secondary">
                        <div class="card-header bg-secondary text-white">
                            <i class="bi bi-briefcase-fill me-2"></i>Mission Briefing
                        </div>
                        <div class="card-body">
                            <p class="mb-0">
                                <strong>Client:</strong> SecureBlog Inc. (Financial Services Edition)<br>
                                <strong>Target:</strong> Enterprise Content Editor v4.7.2<br>
                                <strong>Protection:</strong> Multi-layer XSS Filter System / OWASP ModSecurity Rules<br>
                                <strong>Objective:</strong> Evaluate filter bypass techniques to assess real-world security
                            </p>
                        </div>
                    </div>

                    <p>
                        <strong>Technical Background:</strong> After a security incident last quarter, SecureBlog implemented their "Enterprise Shield" filter - a sophisticated multi-stage content sanitization system that blocks:
                    </p>
                    <ul>
                        <li>Traditional script injection via <code>&lt;script&gt;</code> tags</li>
                        <li>JavaScript URIs via <code>javascript:</code> protocol</li>
                        <li>Event handlers like <code>onerror</code>, <code>onload</code>, etc.</li>
                        <li>Common DOM methods like <code>eval()</code> and <code>document.write()</code></li>
                    </ul>

                    <p>
                        <strong>Real-world Context:</strong> This challenge simulates vulnerabilities found in actual enterprise systems. In 2024, researchers discovered similar filter bypass techniques in major platforms:
                    </p>
                    <ul>
                        <li><strong>CVE-2024-27312:</strong> Bypass in commercial CMS filter through attribute obfuscation ($25,000 bounty)</li>
                        <li><strong>CVE-2023-42501:</strong> Major banking portal XSS through filter evasion</li>
                        <li><strong>HackerOne #1337621:</strong> Enterprise CMS filter bypass affecting 350+ corporate instances</li>
                    </ul>

                    <p>
                        <strong>Business Impact:</strong> In financial and healthcare sectors, XSS filter bypasses can lead to:
                    </p>
                    <ul>
                        <li>Regulatory compliance violations (GDPR, HIPAA, PCI-DSS)</li>
                        <li>Account takeover of privileged users with administrative access</li>
                        <li>Exfiltration of confidential client information</li>
                        <li>Creation of persistent backdoors in content management systems</li>
                        <li>Corporate reputation damage and client trust loss</li>
                    </ul>

                    <p>
                        <strong>Your Task:</strong> As a security consultant, you need to demonstrate that the Enterprise Shield filter can still be bypassed. Create a proof-of-concept that displays an alert with "XSS Level 5 Completed!" to simulate the vulnerability and reveal the flag.
                    </p>
                </div>

                <div class="card mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>SecureBlog Enterprise</h5>
                        <div>
                            <span class="badge bg-light text-dark">v4.7.2</span>
                            <span class="badge bg-warning text-dark">Enterprise Shield</span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Navigation Bar -->
                        <nav class="navbar navbar-expand navbar-light bg-light px-3">
                            <div class="container-fluid">
                                <ul class="navbar-nav">
                                    <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-house-door me-1"></i>Dashboard</a></li>
                                    <li class="nav-item"><a class="nav-link active" href="#"><i class="bi bi-pencil-square me-1"></i>Content</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-bar-chart me-1"></i>Analytics</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-people me-1"></i>Users</a></li>
                                    <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-gear me-1"></i>Settings</a></li>
                                </ul>
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-success me-2">Enterprise License</span>
                                    <div class="dropdown">
                                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-person-circle me-1"></i>Admin User
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </nav>

                        <div class="p-4">
                            <div class="row">
                                <div class="col-md-3 mb-4">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between">
                                            <h6 class="mb-0">Security Status</h6>
                                            <i class="bi bi-shield-check text-success"></i>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <span>Content Shield:</span>
                                                <span class="badge bg-success">Active</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <span>XSS Protection:</span>
                                                <span class="badge bg-success">Level 3</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <span>Input Sanitization:</span>
                                                <span class="badge bg-success">Strict</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <span>WAF Integration:</span>
                                                <span class="badge bg-success">Active</span>
                                            </div>
                                            <hr>
                                            <div class="alert alert-info mb-0 small">
                                                <i class="bi bi-info-circle me-1"></i>
                                                Enterprise Shield Technology: Multi-layer protection against XSS attacks.
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card mt-3">
                                        <div class="card-header">
                                            <h6 class="mb-0">Filter Documentation</h6>
                                        </div>
                                        <div class="card-body small">
                                            <p><strong>Blocked Elements:</strong></p>
                                            <ul class="mb-3">
                                                <li><code>&lt;script&gt;</code> tags</li>
                                                <li><code>&lt;iframe&gt;</code> tags</li>
                                                <li><code>&lt;object&gt;</code> tags</li>
                                                <li><code>&lt;embed&gt;</code> tags</li>
                                            </ul>
                                            <p><strong>Blocked Attributes:</strong></p>
                                            <ul class="mb-3">
                                                <li>Event handlers (onclick, etc.)</li>
                                                <li>javascript: protocol</li>
                                                <li>data: URIs</li>
                                                <li>expression()</li>
                                            </ul>
                                            <p class="text-muted fst-italic">See full security docs for more details...</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-9">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0"><i class="bi bi-pencil-square me-2"></i>Create Financial Report</h5>
                                            <div>
                                                <span class="badge bg-info me-2">Draft</span>
                                                <div class="dropdown d-inline-block">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                        <i class="bi bi-three-dots-vertical"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <form action="/xss-level5" method="post">
                                                <div class="mb-3">
                                                    <label for="title" class="form-label">Report Title</label>
                                                    <input type="text" class="form-control" id="title" name="title" required placeholder="Q2 Financial Summary">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="author" class="form-label">Author</label>
                                                    <input type="text" class="form-control" id="author" name="author" required placeholder="Your name">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="content" class="form-label">Report Content</label>
                                                    <div class="card">
                                                        <div class="card-header bg-light py-1 px-2">
                                                            <div class="btn-group btn-group-sm" role="group">
                                                                <button type="button" class="btn btn-outline-secondary"><i class="bi bi-type-bold"></i></button>
                                                                <button type="button" class="btn btn-outline-secondary"><i class="bi bi-type-italic"></i></button>
                                                                <button type="button" class="btn btn-outline-secondary"><i class="bi bi-type-underline"></i></button>
                                                                <button type="button" class="btn btn-outline-secondary"><i class="bi bi-link"></i></button>
                                                                <button type="button" class="btn btn-outline-secondary"><i class="bi bi-list-ul"></i></button>
                                                                <button type="button" class="btn btn-outline-secondary"><i class="bi bi-list-ol"></i></button>
                                                            </div>
                                                        </div>
                                                        <textarea class="form-control border-top-0 rounded-0 rounded-bottom" id="content" name="content" rows="10" placeholder="Enter your report content here...">{{ content }}</textarea>
                                                    </div>
                                                    <div class="form-text">
                                                        <i class="bi bi-shield-check text-success me-1"></i>
                                                        <small>Enterprise Shield is actively filtering potentially malicious content.</small>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="category" class="form-label">Category</label>
                                                    <select class="form-select" id="category" name="category">
                                                        <option value="financial">Financial Report</option>
                                                        <option value="compliance">Compliance Document</option>
                                                        <option value="quarterly">Quarterly Update</option>
                                                        <option value="audit">Audit Report</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="restrict" name="restrict">
                                                        <label class="form-check-label" for="restrict">
                                                            Restrict to Finance Department
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="text-end">
                                                    <button type="button" class="btn btn-outline-secondary me-2">Save Draft</button>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="bi bi-check-circle me-1"></i>Preview Report
                                                    </button>
                                                </div>
                                            </form>
                                            
                                            {% if message %}
                                            <div class="alert alert-warning mt-3">
                                                <div class="d-flex">
                                                    <div class="me-3">
                                                        <i class="bi bi-shield-exclamation fs-3 text-warning"></i>
                                                    </div>
                                                    <div>
                                                        <h5 class="alert-heading">Security Filter Triggered</h5>
                                                        <p>Enterprise Shield has detected and blocked potentially malicious content:</p>
                                                        <p class="mb-0 text-monospace bg-light p-2 rounded"><code>{{ message }}</code></p>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            {% if filtered_content %}
                                            <div class="card mt-4">
                                                <div class="card-header bg-light">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Report Preview</h5>
                                                        <span class="badge bg-info">Content Filtered</span>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                                    <h4>{{ title }}</h4>
                                                    <p class="text-muted">Author: {{ author }} | Category: {{ category }}</p>
                                                    <hr>
                                                    <div class="content-preview">
                                                        {{ filtered_content | safe }}
                                                    </div>
                                                </div>
                                                <div class="card-footer bg-light">
                                                    <div class="d-flex align-items-center justify-content-between">
                                                        <small class="text-muted">Filtered by Enterprise Shield</small>
                                                        <div>
                                                            <button class="btn btn-sm btn-outline-secondary me-2">Edit</button>
                                                            <button class="btn btn-sm btn-success">Publish</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if flag %}
                <!-- Hidden flag container that will be revealed when the challenge is solved -->
                <div id="flag-display" style="display: none;">
                    <div class="alert alert-success">
                        <h4 class="alert-heading"><i class="bi bi-trophy-fill me-2"></i>Security Vulnerability Confirmed!</h4>
                        <p>
                            Excellent work! You've successfully bypassed the Enterprise Shield content filtering system and demonstrated that the client's XSS protection implementation has weaknesses despite its multiple layers of defense.
                        </p>
                        <hr>
                        <div class="d-flex align-items-center">
                            <div class="me-auto">
                                <p class="mb-0"><strong>Vulnerability Flag:</strong> <code>{{ flag }}</code></p>
                                <p class="text-muted small mt-1 mb-0">
                                    <i class="bi bi-info-circle me-1"></i>In a real penetration test, this would be reported as a high-severity finding with CVSS score ≥8.0
                                </p>
                            </div>
                            <form action="/submit-flag" method="post" class="js-submit-flag">
                                <input type="hidden" name="challenge_id" value="5">
                                <input type="hidden" name="flag" value="{{ flag }}">
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check-circle me-2"></i>Submit Report
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // XSS Detection for Challenge Completion
    window.addEventListener('error', function(e) {
        // Handle XSS alert for challenge completion
        if (window.xssCompleted) {
            const flagDisplay = document.getElementById('flag-display');
            if (flagDisplay) {
                flagDisplay.style.display = 'block';
                flagDisplay.scrollIntoView({ behavior: 'smooth' });
            }
        }
    });
    
    // Override the alert function to detect successful XSS
    const originalAlert = window.alert;
    window.alert = function(message) {
        if (message === "XSS Level 5 Completed!") {
            window.xssCompleted = true;
            const flagDisplay = document.getElementById('flag-display');
            if (flagDisplay) {
                flagDisplay.style.display = 'block';
                flagDisplay.scrollIntoView({ behavior: 'smooth' });
            }
        }
        return originalAlert.apply(this, arguments);
    };
});
</script>
{% endblock %}
